service: mypay-cognito

plugins:
  - serverless-stack-output

provider:
  name: aws
  runtime: nodejs12.x
  region: us-east-1

custom:
  defaultStage: ${file(../../../serverless.common.yml):custom.defaultStage}
  resourcesStages: ${file(../../../serverless.common.yml):custom.resourcesStages}
  resourceStage: ${file(../../../serverless.common.yml):custom.resourcesStage}
  stage: ${file(../../../serverless.common.yml):custom.stage}
  siteBaseUrls:
    prod: prod
    dev: https://release-candidate.d1pgci3xcus5ov.amplifyapp.com/
    qa: qa
    uat: uat
  siteBaseUrl: ${self:custom.siteBaseUrls.${self:custom.resourceStage}, self:custom.siteBaseUrls.dev}

  output:
    file: ../stack-outputs/cognito-${self:custom.stage}.yml

resources:
  Resources:
    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        # Generate a name based on the stage
        UserPoolName: ${self:custom.stage}-user-pool
        # Set email as an alias
        AutoVerifiedAttributes:
          - email
        UsernameAttributes:
          - email
        Schema:
          - AttributeDataType: String
            DeveloperOnlyAttribute: False
            Mutable: True
            Name: email
            Required: True
          - AttributeDataType: String # Comma separated roles
            DeveloperOnlyAttribute: False
            Mutable: True
            Name: roles
            Required: False
          - AttributeDataType: String # Comma separated permissions
            DeveloperOnlyAttribute: False
            Mutable: True
            Name: permissions
            Required: False
        VerificationMessageTemplate:
          DefaultEmailOption: CONFIRM_WITH_LINK
          EmailSubject: Account confirmation
          EmailMessageByLink: Please click the link below to verify your email address. {##Verify Email##} 
        AdminCreateUserConfig:
          InviteMessageTemplate:
            EmailMessage: Your username is {username} and temporary password is {####}. <br> Click <a href='${self:custom.siteBaseUrl}'>here</a> to navigate to MyPay 
            EmailSubject: MyPay Account information
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireLowercase: False
            RequireNumbers: False
            RequireSymbols: False
            RequireUppercase: False

    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        # Generate an app client name based on the stage
        ClientName: ${self:custom.stage}-user-pool-client
        UserPoolId:
          Ref: CognitoUserPool
        ExplicitAuthFlows:
          - ADMIN_NO_SRP_AUTH
        GenerateSecret: false
    CognitoUserPoolDomain:
      Type: AWS::Cognito::UserPoolDomain
      Properties: 
        Domain: ${self:custom.stage}-mypay-domain
        UserPoolId: !Ref CognitoUserPool

    CognitoUserPoolFacebookIdentityProvider:
      Type: AWS::Cognito::UserPoolIdentityProvider
      Properties:
        UserPoolId:
          Ref: CognitoUserPool
        ProviderName: Facebook
        ProviderDetails:
          client_id: 4459505514063167
          client_secret: 7ea91d8b16133a9eae4030159ce39f63
          authorize_scopes: public_profile,email
        ProviderType: Facebook
        AttributeMapping:
          email: email

    CognitoUserPoolGoogleIdentityProvider:
      Type: AWS::Cognito::UserPoolIdentityProvider
      Properties:
        UserPoolId:
          Ref: CognitoUserPool
        ProviderName: Google
        ProviderDetails:
          client_id: 901804385714-acp66260l66qkhdhkg5ulcrrel88ui77.apps.googleusercontent.com
          client_secret: 91JVXjAXVa1RnNhjDrun7e9G
          authorize_scopes: profile email openid
        ProviderType: Google
        AttributeMapping:
          email: email

  Outputs:
    CognitoUserPoolId:
      Value:
        Ref: CognitoUserPool
      Export:
        Name: ${self:custom.stage}-CognitoUserPoolId
    CognitoUserPoolClientId:
      Value:
        Ref: CognitoUserPoolClient
      Export:
        Name: ${self:custom.stage}-CognitoUserPoolClientId
    CognitoUserPoolArn:
      Value: 
        Fn::GetAtt: [CognitoUserPool, Arn]
      Export:
        Name: ${self:custom.stage}-CognitoUserPoolArn